import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from config import default_user_config, load_user_configs, save_user_configs
from data import fetch_klines, fetch_top_symbols_by_volume
from indicators import calculate_indicators
from strategy import score_signal_strength, generate_signal_label
from allocator import allocate_budget_among_signals
from chart import plot_signal_chart

user_settings = load_user_configs()

# ------------------------- ØªØ­Ù„ÛŒÙ„ Ùˆ ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ§Ù… Ø³ÛŒÚ¯Ù†Ø§Ù„ ------------------------- #
from strategy import generate_signal_label, score_signal_strength
from datetime import datetime

def build_signal_message(symbol, tf, df, strat, amount=None):
    from strategy import generate_signal_label, score_signal_strength
    from datetime import datetime

    latest = df.iloc[-1]
    label = generate_signal_label(df, strat)
    score = score_signal_strength(df, strat)

    price = latest["close"]
    tp = price * strat.get("tp_ratio", 1.05)
    sl = price * strat.get("sl_ratio", 0.97)
    rsi = latest["RSI"]
    macd = latest["MACD"]
    signal = latest["Signal"]
    ema50 = latest["EMA50"]
    ema200 = latest["EMA200"]

    msg = f"{label} Ø¨Ø±Ø§ÛŒ {symbol} (ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… {tf})\n\n"

    if label == "âšªï¸ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ù†Ø«ÛŒ":
        msg += "ğŸ¤” Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒâ€ŒØªØµÙ…ÛŒÙ…ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯. Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ Ø´Ù…Ø§ØŒ Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹Ù†Ø§Ø¯Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ ÛŒØ§ ÙØ±ÙˆØ´ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.\n"

        reasons = []
        if strat["use_ema"] and abs(ema50 - ema200) / ema200 < 0.01:
            reasons.append("- EMA50 Ùˆ EMA200 Ø¨Ø³ÛŒØ§Ø± Ù†Ø²Ø¯ÛŒÚ©â€ŒØ§Ù†Ø¯ â†’ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±ÙˆÙ†Ø¯ ÙˆØ§Ø¶Ø­")
        if strat["use_rsi"] and 40 <= rsi <= 60:
            reasons.append(f"- RSI = {rsi:.2f} â†’ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø®Ù†Ø«ÛŒ Ø¨ÛŒÙ† Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´")
        if strat["use_macd"] and abs(macd - signal) < 10:
            reasons.append(f"- MACD â‰ˆ Signal ({macd:.2f} â‰ˆ {signal:.2f}) â†’ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±")

        msg += "\n".join(reasons) if reasons else "- Ø´Ø±Ø§ÛŒØ· ÙˆØ±ÙˆØ¯ Ù…Ù†Ø§Ø³Ø¨ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯."

    else:
        msg += "ğŸ“Œ Ø¯Ù„Ø§ÛŒÙ„ ØµØ¯ÙˆØ± Ø³ÛŒÚ¯Ù†Ø§Ù„:\n"
        if strat["use_ema"]:
            if ema50 > ema200:
                msg += "- EMA50 Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² EMA200 â†’ Ø±ÙˆÙ†Ø¯ ØµØ¹ÙˆØ¯ÛŒ\n"
            else:
                msg += "- EMA50 Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² EMA200 â†’ Ø±ÙˆÙ†Ø¯ Ù†Ø²ÙˆÙ„ÛŒ\n"
        if strat["use_rsi"]:
            rsi_symbol = "<" if rsi < strat["rsi_threshold"] else ">"
            msg += f"- RSI = {rsi:.2f} {rsi_symbol} Ø¢Ø³ØªØ§Ù†Ù‡ {strat['rsi_threshold']}\n"
        if strat["use_macd"]:
            msg += f"- MACD ({macd:.2f}) {'>' if macd > signal else '<'} Signal ({signal:.2f})\n"

        msg += f"""
ğŸ¯ Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯: {price:.2f}
âœ… Ù‡Ø¯Ù Ø³ÙˆØ¯ (TP): {tp:.2f}
â›”ï¸ Ø­Ø¯ Ø¶Ø±Ø± (SL): {sl:.2f}"""

        if amount:
            quantity = amount / price
            profit = (tp - price) * quantity
            loss = (price - sl) * quantity

            msg += f"""
ğŸ’° Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: {amount:.2f} Ø¯Ù„Ø§Ø±
ğŸ“ˆ Ø³ÙˆØ¯ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {profit:.2f} Ø¯Ù„Ø§Ø±
ğŸ“‰ Ø²ÛŒØ§Ù† Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {loss:.2f} Ø¯Ù„Ø§Ø±"""

    # âœ¨ ØªÙˆØ¶ÛŒØ­ Ø§Ù†Ø´Ø§ÛŒÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
    msg += f"""

ğŸ“˜ Ø´Ø±Ø­ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø´Ù…Ø§:
Ø¯Ø± Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø§Ø² Ø³Ù‡ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± EMAØŒ RSI Ùˆ MACD Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± EMA Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ Ø¨Ø§Ø²Ø§Ø± Ø¨ÛŒÙ† Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª Ùˆ Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø¯Ø§Ø±Ø¯. Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÛŒ RSI Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ {strat["rsi_threshold"]} ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ú©Ù‡ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù…Ø¹ÛŒØ§Ø± Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù‡Ù…Ú†Ù†ÛŒÙ† MACD Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ÙˆÙ…Ù†ØªÙˆÙ… Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ø®Ø· Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¢Ù† Ø¨Ù‡ Ú©Ø§Ø± Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.
Ù…ÛŒØ²Ø§Ù† Ø§Ø«Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ø± Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± Ø¯Ø± Ù…Ø¯Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª ØªØ¹ÛŒÛŒÙ† Ø´Ø¯Ù‡ Ø§Ø³Øª:
EMA = {strat['weights']['ema']} | RSI = {strat['weights']['rsi']} | MACD = {strat['weights']['macd']}

â° Ø²Ù…Ø§Ù† ØªØ­Ù„ÛŒÙ„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
"""
    return msg, price, tp, sl


# ------------------------- Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ Ùˆ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ ------------------------- #
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if user_id not in user_settings:
        user_settings[user_id] = default_user_config()
        save_user_configs(user_settings)

    keyboard = [
        [InlineKeyboardButton("ğŸ“ˆ ØªØ­Ù„ÛŒÙ„ ØªÚ©â€ŒÙ†Ù…Ø§Ø¯", callback_data="analyze_single")],
        [InlineKeyboardButton("ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ú¯Ø±ÙˆÙ‡ÛŒ + Ø¨ÙˆØ¯Ø¬Ù‡", callback_data="group_analysis")],
    ]
    await update.message.reply_text("ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                                    reply_markup=InlineKeyboardMarkup(keyboard))

# ------------------------- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù†Ùˆ ------------------------- #
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = str(query.from_user.id)

    if query.data == "analyze_single":
        await query.edit_message_text("Ù„Ø·ÙØ§Ù‹ Ù†Ù…Ø§Ø¯ Ø±Ù…Ø²Ø§Ø±Ø² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ BTCUSDT):")

    elif query.data == "group_analysis":
        await query.edit_message_text("Ù„Ø·ÙØ§Ù‹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¯Ù„Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        context.user_data["expecting_budget"] = True

    elif query.data == "show_settings":
        config = user_settings.get(user_id, default_user_config())
        strat = config["strategy"]

        settings_msg = f"""
ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø´Ù…Ø§:

- EMA: {'ÙØ¹Ø§Ù„' if strat['use_ema'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
- RSI: {'ÙØ¹Ø§Ù„' if strat['use_rsi'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
- MACD: {'ÙØ¹Ø§Ù„' if strat['use_macd'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}

Ø¢Ø³ØªØ§Ù†Ù‡ RSI: {strat['rsi_threshold']}
ÙˆØ²Ù†â€ŒÙ‡Ø§:
 EMA = {strat['weights']['ema']}
 RSI = {strat['weights']['rsi']}
 MACD = {strat['weights']['macd']}

Ù†Ø³Ø¨Øª TP (Ø³ÙˆØ¯): {strat['tp_ratio']}
Ù†Ø³Ø¨Øª SL (Ø¶Ø±Ø±): {strat['sl_ratio']}

ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ: {config.get('timeframe', '15m')}
        """

        toggle_keyboard = [
            [InlineKeyboardButton(f"{'âœ…' if strat['use_ema'] else 'âŒ'} EMA", callback_data="toggle_ema")],
            [InlineKeyboardButton(f"{'âœ…' if strat['use_rsi'] else 'âŒ'} RSI", callback_data="toggle_rsi")],
            [InlineKeyboardButton(f"{'âœ…' if strat['use_macd'] else 'âŒ'} MACD", callback_data="toggle_macd")]
        ]
        keyboard = toggle_keyboard + [
            [InlineKeyboardButton("ØªØºÛŒÛŒØ± Ø¢Ø³ØªØ§Ù†Ù‡ RSI", callback_data="edit_rsi_threshold")],
            [InlineKeyboardButton("ØªÙ†Ø¸ÛŒÙ… ÙˆØ²Ù†â€ŒÙ‡Ø§", callback_data="edit_weights")],
            [InlineKeyboardButton("ØªØºÛŒÛŒØ± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…", callback_data="edit_timeframe")],
            [InlineKeyboardButton("ØªÙ†Ø¸ÛŒÙ… Ù†Ø³Ø¨Øª TP / SL", callback_data="edit_tp_sl")],
            [InlineKeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_menu")]
        ]
        await query.edit_message_text(settings_msg, reply_markup=InlineKeyboardMarkup(keyboard))

    elif query.data == "edit_rsi_threshold":
        await query.edit_message_text("Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¢Ø³ØªØ§Ù†Ù‡ RSI Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ 40):")
        context.user_data["expecting_rsi_threshold"] = True

    elif query.data == "edit_weights":
        await query.edit_message_text("Ù„Ø·ÙØ§Ù‹ ÙˆØ²Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù…Ø«Ø§Ù„:\n0.4 0.3 0.3 (ØªØ±ØªÛŒØ¨: EMA RSI MACD)")
        context.user_data["expecting_weights"] = True

    elif query.data == "edit_tp_sl":
        await query.edit_message_text("Ù†Ø³Ø¨Øª TP Ùˆ SL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù…Ø«Ø§Ù„:\n1.05 0.97")
        context.user_data["expecting_tp_sl"] = True

    elif query.data == "edit_timeframe":
        keyboard = [
            [InlineKeyboardButton("1m", callback_data="tf_1m"),
             InlineKeyboardButton("5m", callback_data="tf_5m"),
             InlineKeyboardButton("15m", callback_data="tf_15m")],
            [InlineKeyboardButton("1h", callback_data="tf_1h"),
             InlineKeyboardButton("4h", callback_data="tf_4h"),
             InlineKeyboardButton("1d", callback_data="tf_1d")],
            [InlineKeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="show_settings")]
        ]
        await query.edit_message_text("ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))

    elif query.data.startswith("tf_"):
        tf = query.data.replace("tf_", "")
        user_settings[user_id]["timeframe"] = tf
        save_user_configs(user_settings)
        await query.edit_message_text(f"ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ {tf} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.")

    elif query.data.startswith("toggle_"):
        key = query.data.replace("toggle_", "")
        current = user_settings[user_id]["strategy"][f"use_{key}"]
        user_settings[user_id]["strategy"][f"use_{key}"] = not current
        save_user_configs(user_settings)
        await query.answer(f"{key.upper()} {'ÙØ¹Ø§Ù„ Ø´Ø¯' if not current else 'ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯'}")
        await button_handler(update, context)


# ------------------------- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ (Ù†Ù…Ø§Ø¯ ÛŒØ§ Ø¨ÙˆØ¯Ø¬Ù‡) ------------------------- #
aasync def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    user_id = str(update.effective_user.id)

    if context.user_data.get("expecting_budget"):
        try:
            budget = float(text)
            context.user_data["expecting_budget"] = False
            await update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§...")
            await group_analysis_and_allocation(update, context, user_id, budget)
        except ValueError:
            await update.message.reply_text("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    if context.user_data.get("expecting_rsi_threshold"):
        try:
            rsi_value = float(text)
            user_settings[user_id]["strategy"]["rsi_threshold"] = rsi_value
            save_user_configs(user_settings)
            context.user_data["expecting_rsi_threshold"] = False
            await update.message.reply_text(f"Ø¢Ø³ØªØ§Ù†Ù‡ RSI Ø¨Ù‡ {rsi_value} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.")
        except:
            await update.message.reply_text("Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.")
        return

    if context.user_data.get("expecting_weights"):
        try:
            parts = text.split()
            if len(parts) != 3:
                raise ValueError("Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û³ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
            ema, rsi, macd = map(float, parts)
            if abs(ema + rsi + macd - 1.0) > 0.01:
                raise ValueError("Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ²Ù†â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Û± Ø¨Ø§Ø´Ø¯.")
            user_settings[user_id]["strategy"]["weights"] = {
                "ema": ema, "rsi": rsi, "macd": macd
            }
            save_user_configs(user_settings)
            context.user_data["expecting_weights"] = False
            await update.message.reply_text("ÙˆØ²Ù†â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.")
        except Exception as e:
            await update.message.reply_text(f"Ø®Ø·Ø§: {str(e)}")
        return

    if context.user_data.get("expecting_tp_sl"):
        try:
            tp, sl = map(float, text.split())
            user_settings[user_id]["strategy"]["tp_ratio"] = tp
            user_settings[user_id]["strategy"]["sl_ratio"] = sl
            save_user_configs(user_settings)
            context.user_data["expecting_tp_sl"] = False
            await update.message.reply_text(f"TP = {tp} | SL = {sl} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")
        except:
            await update.message.reply_text("ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ù…Ø«Ø§Ù„: 1.05 0.97")
        return

    # ØªØ­Ù„ÛŒÙ„ ØªÚ© Ù†Ù…Ø§Ø¯
    symbol = text.upper()
    tf = user_settings.get(user_id, default_user_config()).get("timeframe", "15m")
    df = await fetch_klines(symbol, tf)
    if df is None or df.empty:
        await update.message.reply_text("Ù†Ù…Ø§Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.")
        return

    df = calculate_indicators(df)
    strat = user_settings.get(user_id, default_user_config())["strategy"]
    msg, *_ = build_signal_message(symbol, tf, df, strat)
    await update.message.reply_text(msg)

# ------------------------- ØªØ­Ù„ÛŒÙ„ Ú¯Ø±ÙˆÙ‡ÛŒ + ØªØ®ØµÛŒØµ Ø¨ÙˆØ¯Ø¬Ù‡ ------------------------- #
async def group_analysis_and_allocation(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str, budget: float):
    top_symbols = await fetch_top_symbols_by_volume()
    tf = user_settings[user_id].get("timeframe", "15m")
    strat = user_settings[user_id]["strategy"]

    results = []
    for symbol in top_symbols:
        df = await fetch_klines(symbol, tf)
        if df is None or df.empty:
            continue
        df = calculate_indicators(df)
        score = score_signal_strength(df, strat)
        results.append((symbol, score, df))

    results = sorted(results, key=lambda x: x[1], reverse=True)[:4]
    allocation = allocate_budget_among_signals(results, budget)

    total_profit = 0
    total_loss = 0

    # Ø´Ø±ÙˆØ¹ Ù¾ÛŒØ§Ù…
    await update.message.reply_text(f"ğŸ“¡ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ±ÛŒØ²ÛŒ (ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… {tf}) Ø¨Ø±Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ ${budget:.2f}:")

    # Ø§Ø±Ø³Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ú†Ø§Ø±Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
    for symbol, score, df in results:
        amount = allocation[symbol]["amount"]
        msg, price, tp, sl = build_signal_message(symbol, tf, df, strat, amount)

        label = generate_signal_label(df, strat)
        await update.message.reply_text(msg)

        chart_path = f"{symbol}_chart.png"
        plot_signal_chart(df, symbol, price, tp, sl, chart_path)
        await update.message.reply_photo(photo=open(chart_path, "rb"))

        if label != "âšªï¸ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ù†Ø«ÛŒ":
            quantity = amount / price
            total_profit += (tp - price) * quantity
            total_loss += (price - sl) * quantity

    # Ø§Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ Ù¾ÙˆØ±ØªÙÙˆÛŒ
    from matplotlib import pyplot as plt

    allocation_labels = list(allocation.keys())
    allocation_sizes = [allocation[sym]["amount"] for sym in allocation_labels]

    plt.figure(figsize=(6, 6))
    plt.pie(allocation_sizes, labels=allocation_labels, autopct="%1.1f%%", startangle=140)
    plt.title("Portfolio Allocation", fontsize=14)
    plt.axis("equal")
    plt.tight_layout()

    pie_chart_path = "portfolio_pie_chart.png"
    plt.savefig(pie_chart_path)
    plt.close()

    await update.message.reply_photo(photo=open(pie_chart_path, "rb"))

    # Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù†
    summary = f"""
ğŸ“¡ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ±ÛŒØ²ÛŒ:
ğŸ’¼ Ø³ÙˆØ¯ Ú©Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {total_profit:.2f} Ø¯Ù„Ø§Ø±
ğŸ’£ Ø²ÛŒØ§Ù† Ú©Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {total_loss:.2f} Ø¯Ù„Ø§Ø±
"""
    await update.message.reply_text(summary)
