import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

from config import default_user_config, load_user_configs, save_user_configs
from data import fetch_klines, fetch_top_symbols_by_volume
from indicators import calculate_indicators
from strategy import score_signal_strength, generate_signal_label
from allocator import allocate_budget_among_signals
from chart import plot_signal_chart

user_settings = load_user_configs()


def build_signal_message(symbol, tf, df, strat, amount=None):
    latest = df.iloc[-1]
    label = generate_signal_label(df, strat)
    score = score_signal_strength(df, strat)

    price = latest["close"]
    tp = price * strat.get("tp_ratio", 1.05)
    sl = price * strat.get("sl_ratio", 0.97)
    rsi = latest["RSI"]
    macd = latest["MACD"]
    signal = latest["Signal"]
    ema50 = latest["EMA50"]
    ema200 = latest["EMA200"]

    msg = f"{label} Ø¨Ø±Ø§ÛŒ {symbol} (ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… {tf})\n\n"

    if label == "âšªï¸ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ù†Ø«ÛŒ":
        msg += "ğŸ¤” Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒâ€ŒØªØµÙ…ÛŒÙ…ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯ Ùˆ Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø´Ø®ØµÛŒ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.\n"
        reasons = []
        if strat["use_ema"] and abs(ema50 - ema200) / ema200 < 0.01:
            reasons.append("- EMA50 Ùˆ EMA200 Ø¨Ø³ÛŒØ§Ø± Ù†Ø²Ø¯ÛŒÚ©â€ŒØ§Ù†Ø¯ â†’ Ø¨Ø¯ÙˆÙ† Ø±ÙˆÙ†Ø¯ Ù…Ø´Ø®Øµ")
        if strat["use_rsi"] and 40 <= rsi <= 60:
            reasons.append(f"- RSI = {rsi:.2f} â†’ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø®Ù†Ø«ÛŒ")
        if strat["use_macd"] and abs(macd - signal) < 10:
            reasons.append(f"- MACD â‰ˆ Signal ({macd:.2f} â‰ˆ {signal:.2f}) â†’ Ø¨Ø§Ø²Ø§Ø± Ù…Ù†ØªØ¸Ø± ØªØµÙ…ÛŒÙ… Ø§Ø³Øª")

        msg += "\n".join(reasons) if reasons else "- Ø´Ø±Ø§ÛŒØ· ÙˆØ±ÙˆØ¯ Ù…Ù†Ø§Ø³Ø¨ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯."

    else:
        msg += "ğŸ“Œ Ø¯Ù„Ø§ÛŒÙ„ ØµØ¯ÙˆØ± Ø³ÛŒÚ¯Ù†Ø§Ù„:\n"
        if strat["use_ema"]:
            msg += "- EMA50 Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² EMA200 â†’ Ø±ÙˆÙ†Ø¯ ØµØ¹ÙˆØ¯ÛŒ\n" if ema50 > ema200 else "- EMA50 Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² EMA200 â†’ Ø±ÙˆÙ†Ø¯ Ù†Ø²ÙˆÙ„ÛŒ\n"
        if strat["use_rsi"]:
            rsi_symbol = "<" if rsi < strat["rsi_threshold"] else ">"
            msg += f"- RSI = {rsi:.2f} {rsi_symbol} Ø¢Ø³ØªØ§Ù†Ù‡ {strat['rsi_threshold']}\n"
        if strat["use_macd"]:
            macd_relation = ">" if macd > signal else "<"
            msg += f"- MACD ({macd:.2f}) {macd_relation} Signal ({signal:.2f})\n"

        msg += f"\nğŸ¯ Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯: {price:.2f}\nâœ… Ù‡Ø¯Ù Ø³ÙˆØ¯ (TP): {tp:.2f}\nâ›”ï¸ Ø­Ø¯ Ø¶Ø±Ø± (SL): {sl:.2f}"

        if amount:
            quantity = amount / price
            profit = (tp - price) * quantity
            loss = (price - sl) * quantity
            msg += f"\nğŸ’° Ù…Ø¨Ù„Øº Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: {amount:.2f} Ø¯Ù„Ø§Ø±\nğŸ“ˆ Ø³ÙˆØ¯ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {profit:.2f} Ø¯Ù„Ø§Ø±\nğŸ“‰ Ø²ÛŒØ§Ù† Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: {loss:.2f} Ø¯Ù„Ø§Ø±"

    msg += f"\n\nğŸ“˜ Ø´Ø±Ø­ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø´Ù…Ø§:\n"
    msg += "Ø¯Ø± Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø§Ø² Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ÛŒ EMAØŒ RSI Ùˆ MACD Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. EMA Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ RSI Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´ØŒ Ùˆ MACD Ø¨Ø±Ø§ÛŒ Ø³Ù†Ø¬Ø´ Ù…ÙˆÙ…Ù†ØªÙˆÙ… Ø¨Ø§Ø²Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.\n"
    msg += f"ğŸš Ø¢Ø³ØªØ§Ù†Ù‡ RSI = {strat['rsi_threshold']}\n"
    msg += f"âš–ï¸ ÙˆØ²Ù†â€ŒÙ‡Ø§: EMA = {strat['weights']['ema']} | RSI = {strat['weights']['rsi']} | MACD = {strat['weights']['macd']}\n"
    msg += f"â° Ø²Ù…Ø§Ù† ØªØ­Ù„ÛŒÙ„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    return msg, price, tp, sl


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if user_id not in user_settings:
        user_settings[user_id] = default_user_config()
        save_user_configs(user_settings)

    keyboard = [
        [InlineKeyboardButton("ğŸ“ˆ ØªØ­Ù„ÛŒÙ„ ØªÚ©â€ŒÙ†Ù…Ø§Ø¯", callback_data="analyze_single")],
        [InlineKeyboardButton("ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ±ÛŒØ²ÛŒ", callback_data="group_analysis")],
        [InlineKeyboardButton("âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ­Ù„ÛŒÙ„Ú¯Ø±", callback_data="show_settings")]
    ]
    await update.message.reply_text("ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø± Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                                    reply_markup=InlineKeyboardMarkup(keyboard))


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = str(query.from_user.id)

    if query.data == "analyze_single":
        await query.edit_message_text("ğŸ” Ù„Ø·ÙØ§Ù‹ Ù†Ù…Ø§Ø¯ Ø±Ù…Ø²Ø§Ø±Ø² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ BTCUSDT):")

    elif query.data == "group_analysis":
        await query.edit_message_text("ğŸ’° Ù„Ø·ÙØ§Ù‹ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¯Ù„Ø§Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        context.user_data["expecting_budget"] = True

    elif query.data == "show_settings":
        config = user_settings.get(user_id, default_user_config())
        strat = config["strategy"]
        msg = f"""ğŸ›  ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø´Ù…Ø§:

- EMA: {'ÙØ¹Ø§Ù„' if strat['use_ema'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
- RSI: {'ÙØ¹Ø§Ù„' if strat['use_rsi'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
- MACD: {'ÙØ¹Ø§Ù„' if strat['use_macd'] else 'ØºÛŒØ±ÙØ¹Ø§Ù„'}

ğŸš Ø¢Ø³ØªØ§Ù†Ù‡ RSI: {strat['rsi_threshold']}
âš–ï¸ ÙˆØ²Ù†â€ŒÙ‡Ø§: EMA = {strat['weights']['ema']} | RSI = {strat['weights']['rsi']} | MACD = {strat['weights']['macd']}
ğŸ¯ TP: {strat['tp_ratio']} | â›” SL: {strat['sl_ratio']}
â± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…: {config.get("timeframe", "15m")}
"""
        keyboard = [
            [InlineKeyboardButton("ğŸš ØªØºÛŒÛŒØ± Ø¢Ø³ØªØ§Ù†Ù‡ RSI", callback_data="edit_rsi_threshold")],
            [InlineKeyboardButton("âš–ï¸ ØªØºÛŒÛŒØ± ÙˆØ²Ù†â€ŒÙ‡Ø§", callback_data="edit_weights")],
            [InlineKeyboardButton("ğŸ¯ ØªØºÛŒÛŒØ± TP/SL", callback_data="edit_tp_sl")],
            [InlineKeyboardButton("â± ØªØºÛŒÛŒØ± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…", callback_data="edit_timeframe")],
        ]
        await query.edit_message_text(msg, reply_markup=InlineKeyboardMarkup(keyboard))

    elif query.data.startswith("toggle_"):
        key = query.data.replace("toggle_", "")
        user_settings[user_id]["strategy"][f"use_{key}"] ^= True
        save_user_configs(user_settings)
        await button_handler(update, context)

    elif query.data.startswith("tf_"):
        tf = query.data.replace("tf_", "")
        user_settings[user_id]["timeframe"] = tf
        save_user_configs(user_settings)
        await query.edit_message_text(f"â± ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ø¨Ù‡ {tf} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.")

    elif query.data == "edit_rsi_threshold":
        context.user_data["expecting_rsi_threshold"] = True
        await query.edit_message_text("ğŸš Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ RSI Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹ 40):")

    elif query.data == "edit_weights":
        context.user_data["expecting_weights"] = True
        await query.edit_message_text("âš–ï¸ Ù„Ø·ÙØ§Ù‹ ÙˆØ²Ù†â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯. Ù…Ø«Ù„: 0.4 0.3 0.3")

    elif query.data == "edit_tp_sl":
        context.user_data["expecting_tp_sl"] = True
        await query.edit_message_text("ğŸ¯ Ù„Ø·ÙØ§Ù‹ Ù†Ø³Ø¨Øª TP/SL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: 1.05 0.97)")

    elif query.data == "edit_timeframe":
        timeframes = ["1m", "5m", "15m", "1h", "4h", "1d"]
        keyboard = [[InlineKeyboardButton(tf, callback_data=f"tf_{tf}") for tf in timeframes[i:i + 3]] for i in range(0, 6, 3)]
        await query.edit_message_text("â± Ù„Ø·ÙØ§Ù‹ ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                                      reply_markup=InlineKeyboardMarkup(keyboard))


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    user_id = str(update.effective_user.id)

    if context.user_data.get("expecting_budget"):
        try:
            budget = float(text)
            context.user_data["expecting_budget"] = False
            await update.message.reply_text("âŒ› Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±...")
            await group_analysis_and_allocation(update, context, user_id, budget)
        except ValueError:
            await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    if context.user_data.get("expecting_rsi_threshold"):
        try:
            rsi_val = float(text)
            user_settings[user_id]["strategy"]["rsi_threshold"] = rsi_val
            save_user_configs(user_settings)
            context.user_data["expecting_rsi_threshold"] = False
            await update.message.reply_text(f"ğŸš Ø¢Ø³ØªØ§Ù†Ù‡ RSI Ø¨Ù‡ {rsi_val} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª.")
        except:
            await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.")
        return

    if context.user_data.get("expecting_weights"):
        try:
            parts = list(map(float, text.split()))
            if len(parts) != 3 or abs(sum(parts) - 1.0) > 0.01:
                raise ValueError("âš–ï¸ ÙˆØ²Ù†â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Û³ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ù†Ø¯ Ú©Ù‡ Ù…Ø¬Ù…ÙˆØ¹Ø´Ø§Ù† Û± Ø´ÙˆØ¯.")
            user_settings[user_id]["strategy"]["weights"] = dict(zip(["ema", "rsi", "macd"], parts))
            save_user_configs(user_settings)
            context.user_data["expecting_weights"] = False
            await update.message.reply_text("âœ… ÙˆØ²Ù†â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯.")
        except Exception as e:
            await update.message.reply_text(f"âŒ Ø®Ø·Ø§: {str(e)}")
        return

    if context.user_data.get("expecting_tp_sl"):
        try:
            tp, sl = map(float, text.split())
            user_settings[user_id]["strategy"]["tp_ratio"] = tp
            user_settings[user_id]["strategy"]["sl_ratio"] = sl
            save_user_configs(user_settings)
            context.user_data["expecting_tp_sl"] = False
            await update.message.reply_text("ğŸ¯ Ù†Ø³Ø¨Øª TP / SL Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")
        except:
            await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø¯Ùˆ Ø¹Ø¯Ø¯ Ù…Ø«Ù„ '1.05 0.97' ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return

    # ØªØ­Ù„ÛŒÙ„ ØªÚ© Ù†Ù…Ø§Ø¯
    symbol = text.upper()
    tf = user_settings.get(user_id, default_user_config()).get("timeframe", "15m")
    df = await fetch_klines(symbol, tf)
    if df is None or df.empty:
        await update.message.reply_text("âŒ Ù†Ù…Ø§Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.")
        return

    df = calculate_indicators(df)
    strat = user_settings[user_id]["strategy"]
    msg, *_ = build_signal_message(symbol, tf, df, strat)
    await update.message.reply_text(msg)



async def group_analysis_and_allocation(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str, budget: float):
    tf = user_settings[user_id].get("timeframe", "15m")
    strat = user_settings[user_id]["strategy"]

    top_symbols = await fetch_top_symbols_by_volume()
    results = []

    for symbol in top_symbols:
        df = await fetch_klines(symbol, tf)
        if df is None or df.empty:
            continue
        df = calculate_indicators(df)
        score = score_signal_strength(df, strat)
        results.append((symbol, score, df))

    results = sorted(results, key=lambda x: x[1], reverse=True)[:4]
    allocation = allocate_budget_among_signals(results, budget)

    await update.message.reply_text(f"ğŸ“Š Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒØ¯Ù‡ÛŒ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… {tf} Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡ ${budget:.2f}:")

    total_profit, total_loss = 0, 0

    for symbol, score, df in results:
        amount = allocation[symbol]["amount"]
        msg, price, tp, sl = build_signal_message(symbol, tf, df, strat, amount)
        await update.message.reply_text(msg)

        chart_path = f"{symbol}_chart.png"
        plot_signal_chart(df, symbol, price, tp, sl, chart_path)
        await update.message.reply_photo(photo=open(chart_path, "rb"))

        quantity = amount / price
        total_profit += (tp - price) * quantity
        total_loss += (price - sl) * quantity

    await update.message.reply_text(f"ğŸ’¼ Ø³ÙˆØ¯ Ú©Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: ${total_profit:.2f}\nğŸ’£ Ø²ÛŒØ§Ù† Ú©Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: ${total_loss:.2f}")




